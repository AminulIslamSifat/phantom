<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ filename }} • Premium Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="theme-color" content="#0a0a0a">
  
  <!-- Optimized font loading with display swap -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
  
  <!-- Critical PrismJS loading -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" id="prism-theme">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">

  <style>
    :root {
      /* Dark theme variables */
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a24;
      --bg-glass: rgba(26, 26, 36, 0.7);
      --bg-modal: rgba(10, 10, 15, 0.95);
      
      --text-primary: #ffffff;
      --text-secondary: #a8a8b3;
      --text-muted: #6c6c80;
      
      --accent-primary: #00d4ff;
      --accent-secondary: #00ff88;
      --accent-tertiary: #ff6b6b;
      --accent-warning: #ffaa00;
      
      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-strong: rgba(255, 255, 255, 0.15);
      
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.3);
      
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
      --transition-slow: 0.4s ease;
      
      --blur-glass: 16px;
      --border-radius: 16px;
      --border-radius-sm: 12px;
      --border-radius-xs: 8px;
    }

    body.light {
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f5f5f5;
      --bg-glass: rgba(255, 255, 255, 0.8);
      --bg-modal: rgba(250, 250, 250, 0.95);
      
      --text-primary: #1a1a1a;
      --text-secondary: #4a4a4a;
      --text-muted: #8a8a8a;
      
      --border-subtle: rgba(0, 0, 0, 0.08);
      --border-strong: rgba(0, 0, 0, 0.15);
      
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.2);
      --shadow-glow: 0 0 20px rgba(0, 123, 255, 0.2);
    }

    /* Performance optimizations */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-weight: 400;
      line-height: 1.6;
      color: var(--text-primary);
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      will-change: background;
      transition: background var(--transition-normal);
    }

    /* Animated background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 255, 136, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 107, 107, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
      animation: backgroundShift 20s ease-in-out infinite;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(-20px, -10px) scale(1.05); }
      66% { transform: translate(20px, 10px) scale(0.95); }
    }

    /* Main container with premium glass effect */
    .app-container {
      min-height: 100vh;
      padding: clamp(0.5rem, 2vw, 1.5rem);
      display: flex;
      flex-direction: column;
    }

    .main-panel {
      flex: 1;
      background: var(--bg-glass);
      backdrop-filter: blur(var(--blur-glass));
      -webkit-backdrop-filter: blur(var(--blur-glass));
      border-radius: var(--border-radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      will-change: transform;
      transition: all var(--transition-normal);
    }

    /* Premium header with floating elements */
    .app-header {
      background: var(--bg-glass);
      backdrop-filter: blur(var(--blur-glass));
      padding: clamp(0.75rem, 2vw, 1.25rem);
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
      font-size: clamp(1.1rem, 3vw, 1.4rem);
      color: var(--text-primary);
    }

    .header-icon {
      width: 28px;
      height: 28px;
      color: var(--accent-primary);
      filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.3));
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    /* Premium button system */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: clamp(0.5rem, 1.5vw, 0.75rem) clamp(0.75rem, 2vw, 1.25rem);
      border: none;
      border-radius: var(--border-radius-sm);
      font-weight: 500;
      font-size: clamp(0.85rem, 2vw, 0.95rem);
      text-decoration: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
      will-change: transform, box-shadow;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left var(--transition-normal);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), #0099cc);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      box-shadow: var(--shadow-glow), var(--shadow-md);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--accent-secondary), #00cc66);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-tertiary {
      background: linear-gradient(135deg, var(--accent-tertiary), #ff4757);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-ghost {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .btn-ghost:hover {
      background: var(--bg-glass);
      color: var(--text-primary);
      border-color: var(--border-strong);
    }

    /* Content area with premium styling */
    .content-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content-header {
      background: var(--bg-secondary);
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filename {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-weight: 500;
      font-size: clamp(0.9rem, 2vw, 1rem);
      color: var(--text-primary);
      padding: 0.5rem 0.75rem;
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-xs);
      border: 1px solid var(--border-subtle);
      word-break: break-all;
    }

    .content-actions {
      display: flex;
      gap: 0.5rem;
    }

    .content-area {
      flex: 1;
      overflow: auto;
      background: var(--bg-secondary);
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: clamp(0.85rem, 2vw, 0.95rem);
      line-height: 1.6;
    }

    .content-area::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .content-area::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
    }

    .content-area::-webkit-scrollbar-thumb {
      background: var(--border-strong);
      border-radius: 4px;
    }

    .content-area::-webkit-scrollbar-thumb:hover {
      background: var(--accent-primary);
    }

    /* Image display */
    .content-area img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 2rem auto;
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-md);
      transition: transform var(--transition-normal);
    }

    .content-area img:hover {
      transform: scale(1.02);
    }

    /* Database tables */
    .db-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .db-table th,
    .db-table td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border-subtle);
    }

    .db-table th {
      background: var(--bg-glass);
      font-weight: 600;
      color: var(--text-primary);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .db-table td {
      color: var(--text-secondary);
    }

    .db-table tr:hover td {
      background: var(--bg-glass);
      color: var(--text-primary);
    }

    /* Code styling enhancements */
    pre {
      margin: 0;
      padding: 1.5rem !important;
      font-size: inherit;
      line-height: 1.6;
      border-radius: 0;
    }

    .line-numbers .line-numbers-rows {
      border-right: 1px solid var(--border-subtle) !important;
      padding-right: 1rem !important;
    }

    /* Modal system */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-modal);
      backdrop-filter: blur(var(--blur-glass));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-lg);
      width: 90vw;
      max-width: 600px;
      height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: scale(0.9) translateY(20px);
      transition: transform var(--transition-normal);
    }

    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      padding: 1.25rem;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-glass);
    }

    .modal-title {
      font-weight: 600;
      font-size: 1.2rem;
      color: var(--text-primary);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 50%;
      transition: all var(--transition-fast);
    }

    .close-btn:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem;
      margin: 1rem;
      margin-bottom: 0;
      width: calc(100% - 2rem);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--border-radius-xs);
      color: var(--text-primary);
      font-family: inherit;
      transition: all var(--transition-fast);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .file-tree-container {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }

    .file-tree {
      list-style: none;
    }

    .file-item {
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      border-left: 3px solid transparent;
    }

    .file-item:hover {
      background: var(--bg-glass);
      border-left-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .file-item.folder {
      font-weight: 500;
    }

    .file-item.folder::before {
      content: '📁';
      font-size: 1rem;
    }

    .file-item.file::before {
      content: '📄';
      font-size: 1rem;
      opacity: 0.7;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .app-container {
        padding: 0.5rem;
      }
      
      .app-header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }
      
      .header-actions {
        justify-content: center;
      }
      
      .content-header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
      }
      
      .content-actions {
        justify-content: center;
      }

      .modal-content {
        width: 95vw;
        height: 90vh;
      }
    }

    /* Loading states */
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Accessibility improvements */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      body::before {
        animation: none;
      }
    }

    /* Focus styles */
    .btn:focus,
    .search-input:focus,
    .file-item:focus {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }

    /* Print styles */
    @media print {
      .app-header,
      .content-header,
      .modal-overlay {
        display: none !important;
      }
      
      .content-area {
        overflow: visible !important;
      }
    }
  </style>
</head>

<body class="dark">
  <!-- File Browser Modal -->
  <div class="modal-overlay" id="fileModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Browse Files</h3>
        <button class="close-btn" id="closeModal" aria-label="Close">&times;</button>
      </div>
      <input type="text" class="search-input" id="fileSearch" placeholder="Search files...">
      <div class="file-tree-container">
        <ul class="file-tree" id="fileTree">
          <!-- Populated by JavaScript -->
        </ul>
      </div>
    </div>
  </div>

  <div class="app-container">
    <div class="main-panel">
      <!-- Header -->
      <header class="app-header">
        <div class="header-title">
          <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10,9 9,9 8,9"/>
          </svg>
          Premium Viewer
        </div>
        
        <div class="header-actions">
          <button class="btn btn-primary" id="browseBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
            Browse
          </button>
          <a class="btn btn-secondary" href="/edit/{{ filename }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit
          </a>
          <button class="btn btn-ghost" id="themeBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            Theme
          </button>
        </div>
      </header>

      <!-- Content -->
      <div class="content-wrapper">
        <div class="content-header">
          <div class="filename">{{ filename }}</div>
          <div class="content-actions">
            <button class="btn btn-ghost" id="copyBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
              </svg>
              Copy
            </button>
            <button class="btn btn-ghost" id="downloadBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Download
            </button>
          </div>
        </div>
        <div class="content-area" id="contentArea">
          <!-- Content populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Optimized script loading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

  <script>
    class PremiumFileViewer {
      constructor() {
        this.currentTheme = 'dark';
        this.fileData = null;
        this.init();
      }

      init() {
        this.bindEvents();
        this.loadInitialContent();
        this.loadFileTree();
      }

      bindEvents() {
        // Theme toggle
        document.getElementById('themeBtn').addEventListener('click', () => this.toggleTheme());
        
        // Modal controls
        document.getElementById('browseBtn').addEventListener('click', () => this.showModal());
        document.getElementById('closeModal').addEventListener('click', () => this.hideModal());
        document.getElementById('fileModal').addEventListener('click', (e) => {
          if (e.target.id === 'fileModal') this.hideModal();
        });

        // File actions
        document.getElementById('copyBtn').addEventListener('click', () => this.copyContent());
        document.getElementById('downloadBtn').addEventListener('click', () => this.downloadFile());

        // Search
        document.getElementById('fileSearch').addEventListener('input', (e) => this.filterFiles(e.target.value));

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
      }

      getFileType(filename) {
        const ext = filename.split('.').pop()?.toLowerCase() || '';
        
        if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg', 'webp'].includes(ext)) {
          return 'image';
        }
        
        if (ext === 'db') {
          return 'database';
        }
        
        const langMap = {
          'js': 'javascript',
          'jsx': 'javascript',
          'ts': 'typescript', 
          'tsx': 'typescript',
          'py': 'python',
          'css': 'css',
          'scss': 'scss',
          'html': 'markup',
          'xml': 'markup',
          'json': 'json',
          'md': 'markdown',
          'sql': 'sql',
          'sh': 'bash',
          'yml': 'yaml',
          'yaml': 'yaml'
        };
        
        return langMap[ext] || 'markup';
      }

      loadInitialContent() {
        const filename = document.querySelector('.filename').textContent;
        const content = {{ content|tojson }};
        this.renderContent(filename, content);
      }

      renderContent(filename, content) {
        const contentArea = document.getElementById('contentArea');
        const fileType = this.getFileType(filename);
        
        // Clear and prepare
        contentArea.innerHTML = '';
        contentArea.className = 'content-area';

        if (fileType === 'image') {
          this.renderImage(contentArea, filename);
        } else if (fileType === 'database') {
          this.renderDatabase(contentArea, content);
        } else {
          this.renderCode(contentArea, content, fileType);
        }
      }

      renderImage(container, filename) {
        container.innerHTML = `<img src="/raw_file/${filename}" alt="${filename}" loading="lazy">`;
      }

      renderDatabase(container, content) {
        try {
          const data = JSON.parse(content);
          let html = '';
          
          data.forEach(table => {
            html += `<h3 style="margin: 2rem 1rem 1rem; color: var(--text-primary); font-weight: 600;">Table: ${table.name}</h3>`;
            
            if (!table.rows?.length) {
              html += '<p style="margin: 1rem; color: var(--text-muted);">This table is empty.</p>';
              return;
            }
            
            html += '<table class="db-table"><thead><tr>';
            table.columns.forEach(col => html += `<th>${this.escapeHtml(col)}</th>`);
            html += '</tr></thead><tbody>';
            
            table.rows.forEach(row => {
              html += '<tr>';
              table.columns.forEach(col => {
                const value = row[col] ?? '';
                html += `<td>${this.escapeHtml(String(value))}</td>`;
              });
              html += '</tr>';
            });
            
            html += '</tbody></table>';
          });
          
          container.innerHTML = html;
        } catch (error) {
          container.innerHTML = `<pre style="padding: 2rem; color: var(--accent-tertiary);">Error parsing database: ${error.message}</pre>`;
        }
      }

      renderCode(container, content, fileType) {
        container.classList.add('line-numbers');
        const escapedContent = this.escapeHtml(content);
        const language = fileType === 'markup' ? 'markup' : fileType;
        
        container.innerHTML = `<pre><code class="language-${language}">${escapedContent}</code></pre>`;
        
        // Highlight with error handling
        try {
          Prism.highlightAllUnder(container);
        } catch (error) {
          console.warn('Syntax highlighting failed:', error);
        }
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      async loadFileTree() {
        try {
          const response = await fetch('/api/files');
          const fileSystem = await response.json();
          this.renderFileTree(fileSystem);
        } catch (error) {
          console.error('Failed to load file tree:', error);
          document.getElementById('fileTree').innerHTML = '<li style="padding: 1rem; color: var(--accent-tertiary);">Failed to load files</li>';
        }
      }

      renderFileTree(files, container = document.getElementById('fileTree'), basePath = '') {
        container.innerHTML = '';
        
        files.forEach(file => {
          const item = document.createElement('li');
          const currentPath = basePath ? `${basePath}/${file.name}` : file.name;
          
          if (file.type === 'folder') {
            item.className = 'file-item folder';
            item.textContent = file.name;
            item.addEventListener('click', () => {
              // Toggle folder (could be expanded in future)
              console.log('Folder clicked:', currentPath);
            });
            
            if (file.children?.length) {
              const nestedList = document.createElement('ul');
              nestedList.className = 'file-tree';
              nestedList.style.paddingLeft = '1rem';
              this.renderFileTree(file.children, nestedList, currentPath);
              item.appendChild(nestedList);
            }
          } else {
            item.className = 'file-item file';
            item.textContent = file.name;
            item.dataset.filepath = currentPath;
            item.addEventListener('click', () => {
              window.location.href = `/view/${currentPath}`;
            });
          }
          
          container.appendChild(item);
        });
      }

      filterFiles(query) {
        const items = document.querySelectorAll('.file-item');
        const searchTerm = query.toLowerCase();
        
        items.forEach(item => {
          const text = item.textContent.toLowerCase();
          const match = text.includes(searchTerm);
          item.style.display = match ? 'flex' : 'none';
        });
      }

      showModal() {
        document.getElementById('fileModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        // Focus search input for better UX
        setTimeout(() => document.getElementById('fileSearch').focus(), 100);
      }

      hideModal() {
        document.getElementById('fileModal').classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('fileSearch').value = '';
        this.filterFiles(''); // Reset filter
      }

      async copyContent() {
        const contentArea = document.getElementById('contentArea');
        const filename = document.querySelector('.filename').textContent;
        const fileType = this.getFileType(filename);
        
        if (fileType === 'image') {
          this.showNotification('Cannot copy image content', 'warning');
          return;
        }

        try {
          const text = contentArea.innerText || contentArea.textContent;
          await navigator.clipboard.writeText(text);
          this.showNotification('Copied to clipboard!', 'success');
        } catch (error) {
          console.error('Copy failed:', error);
          this.showNotification('Copy failed', 'error');
        }
      }

      downloadFile() {
        const filename = document.querySelector('.filename').textContent;
        const fileType = this.getFileType(filename);
        
        if (fileType === 'image') {
          // Direct download for images
          const link = document.createElement('a');
          link.href = `/raw_file/${filename}`;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } else {
          // Download text content
          const content = document.getElementById('contentArea').innerText || document.getElementById('contentArea').textContent;
          const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          URL.revokeObjectURL(url);
        }
        
        this.showNotification('Download started', 'success');
      }

      toggleTheme() {
        this.currentTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        document.body.className = this.currentTheme;
        
        // Update Prism theme
        const themeLink = document.getElementById('prism-theme');
        const newTheme = this.currentTheme === 'light' 
          ? 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css'
          : 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css';
        themeLink.href = newTheme;
        
        // Save preference
        try {
          localStorage.setItem('theme', this.currentTheme);
        } catch (error) {
          // localStorage not available
        }
        
        this.showNotification(`Switched to ${this.currentTheme} theme`, 'success');
      }

      handleKeyboard(event) {
        // Ctrl/Cmd + C for copy
        if ((event.ctrlKey || event.metaKey) && event.key === 'c' && !event.target.matches('input, textarea')) {
          event.preventDefault();
          this.copyContent();
        }
        
        // Ctrl/Cmd + B for browse
        if ((event.ctrlKey || event.metaKey) && event.key === 'b') {
          event.preventDefault();
          this.showModal();
        }
        
        // Escape to close modal
        if (event.key === 'Escape') {
          this.hideModal();
        }
        
        // Ctrl/Cmd + T for theme toggle
        if ((event.ctrlKey || event.metaKey) && event.key === 't') {
          event.preventDefault();
          this.toggleTheme();
        }
      }

      showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        // Style the notification
        Object.assign(notification.style, {
          position: 'fixed',
          top: '2rem',
          right: '2rem',
          padding: '0.75rem 1.25rem',
          background: type === 'success' ? 'var(--accent-secondary)' :
                     type === 'warning' ? 'var(--accent-warning)' :
                     type === 'error' ? 'var(--accent-tertiary)' : 'var(--accent-primary)',
          color: 'white',
          borderRadius: 'var(--border-radius-xs)',
          boxShadow: 'var(--shadow-lg)',
          zIndex: '10000',
          transform: 'translateX(100%)',
          transition: 'transform var(--transition-normal)',
          fontWeight: '500',
          maxWidth: '300px',
          wordBreak: 'break-word'
        });
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
        }, 10);
        
        // Remove after delay
        setTimeout(() => {
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      // Load saved theme on startup
      loadSavedTheme() {
        try {
          const savedTheme = localStorage.getItem('theme');
          if (savedTheme && savedTheme !== this.currentTheme) {
            this.toggleTheme();
          }
        } catch (error) {
          // localStorage not available
        }
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        window.fileViewer = new PremiumFileViewer();
        window.fileViewer.loadSavedTheme();
      });
    } else {
      window.fileViewer = new PremiumFileViewer();
      window.fileViewer.loadSavedTheme();
    }

    // Performance optimizations
    
    // Preload critical resources
    const preloadLinks = [
      'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js'
    ];

    preloadLinks.forEach(href => {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = 'script';
      link.href = href;
      document.head.appendChild(link);
    });

    // Intersection Observer for lazy loading improvements
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
              imageObserver.unobserve(img);
            }
          }
        });
      }, { rootMargin: '50px' });
      
      // Observe any images added dynamically
      const mutationObserver = new MutationObserver((mutations) => {
        mutations.forEach(mutation => {
          mutation.addedNodes.forEach(node => {
            if (node.nodeType === 1 && node.tagName === 'IMG' && node.dataset.src) {
              imageObserver.observe(node);
            }
          });
        });
      });
      
      mutationObserver.observe(document.body, { childList: true, subtree: true });
    }

    // Service Worker registration for offline support (optional)
    if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
      navigator.serviceWorker.register('/sw.js').catch(() => {
        // Service worker registration failed, but that's okay
      });
    }
  </script>
</body>
</html>